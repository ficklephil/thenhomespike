<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0 }
      #map-canvas { height: 100% }
    </style>
	
	<style type="text/css" >
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0 }
      #map-canvas { height: 100% }
    </style>
	
	<link rel="stylesheet" type="text/css" href="spike_style.css" />
    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
    <script type="text/javascript"
      src="http://maps.googleapis.com/maps/api/js?key=AIzaSyA5Zhn0d70pprD2K2ogELhYwmJy_N32le4&sensor=false">
    </script>
    <script type="text/javascript">
	
		//ndow.onload = init;
		
		function getItemAPI(location,centerLat,centerLng,lat_lo,lng_lo,lat_hi,lng_hi){
            console.log('Get Item API');

            //var url = 'http://127.0.0.1:1337/?callback=?';

            var mapWidth = $('#map-canvas').width();
            var mapHeight = $('#map-canvas').height();

            //var url = 'http://127.0.0.1:1337/?screenResolutionX='+mapWidth+'&screenResolutionY='+mapHeight+'&placeName='+location+'&callback=?';
            var url = 'http://127.0.0.1:1337/?screenResolutionX='+mapWidth+'&screenResolutionY='+mapHeight+'&placeName='+location+'&centerLat='+centerLat+'&centerLng='+centerLng+'&lat_lo='+lat_lo+'&lng_lo='+lng_lo+'&lat_hi='+lat_hi+'&lng_hi='+lng_hi+'&callback=?';

            $.ajax({
                type: 'GET',
                url: url,
                async: false,
                jsonpCallback: 'jsonCallback',
                contentType: "application/json",
                dataType: 'jsonp',
                success: function(json) {
                    //console.log(JSON.stringify(json.request));
                    parseJson(json);
                },
                error: function(e) {
                    console.log(e.message);
                }
            });
        }

        function parseJson(json)
        {
            parseMarkers(json);
        }

        function parseMarkers(json){

            console.log('parse markers');

            var responseLat = json.response.locations[0].center_lat;
            var responseLng = json.response.locations[0].center_long;

           // console.log('lat + lng : ' + JSON.stringify(responseLat.center_lat));// + responseLng);
            moveMap(responseLat,responseLng);

            var listings = json.response.listings;
            console.log(listings.length);

            for(var i=0; i < listings.length; i++){
                console.log("Item Title " + listings[i].title);
                console.log("Item Marker X " + listings[i].itemMarkerX);
                console.log("Item Marker Y " + listings[i].itemMarkerY);
                console.log("Price " + listings[i].price);

                addItemToDisplay(listings[i].property_type,listings[i].itemMarkerX, listings[i].itemMarkerY,listings[i].price_formatted, listings[i].bedroom_number );
            }
        }

        function moveMap(responseLat,responseLng)
        {
            console.log('move map');
            var locationLatLng = new google.maps.LatLng(responseLat, responseLng);
            map.panTo(locationLatLng);
        }

        function addItemToDisplay(itemType,x,y,price_formatted,bedroom_number){

            //add item to display-layer
            console.log('add item to display');
            $('.display-layer').append('<div class="dot-item '+itemType+'" style="left:'+ x +'px; top:'+ y +'px;"><div class="price">'+price_formatted+'</div>' +
                    '<div class="beds">Beds '+bedroom_number+'</div></div>');
        }

        var map;
			
		function initialize() {
            var lat = 51.46549649642391;
            var lng = -0.37975222192383473;

            var mapOptions = {
			  center: new google.maps.LatLng(lat, lng),
			  zoom: 13,
			  sensors:false,
			  mapTypeId: google.maps.MapTypeId.ROADMAP
			};
			map = new google.maps.Map(document.getElementById("map-canvas"),
				mapOptions);

            google.maps.event.addListener(map, 'idle', function(){

                //perhaps use .toUrlValue() to get lat lng values as url
                //lat_lo,lng_lo,lat_hi,lng_hi
                //51.430994,-0.488156,51.499972,-0.271348
//                var bounds = map.getBounds();
//                var northEastCorner = bounds.getNorthEast();
//                var southWestCorner = bounds.getSouthWest();
//
//                console.log(southWestCorner);
//
//                //var lat_lo, lng_lo, lat_hi, lng_hi;
//                lat_hi = northEastCorner.lat();
//                lng_hi = northEastCorner.lng();
//                lat_lo = southWestCorner.lat();
//                lng_lo = southWestCorner.lng();
//
//                console.log('Movement');
//
//                                         //getBounds?
//                var centerLatLng = map.getCenter();
//                console.log(centerLatLng.lat());
//                console.log(centerLatLng.lng());
//
//                var location ='hounslow';

               // getItemAPI(location,centerLatLng.lat(),centerLatLng.lng(),lat_lo,lng_lo,lat_hi,lng_hi);
            });


			placeDotOnMapAtXY();
		  }
		  google.maps.event.addDomListener(window, 'load', initialize);

        function placeDotOnMapAtXY(){
			//mark a point
			var lat = 51.448979;
			var lng = -0.334396;
			if(map)
			{
				var overlay = new google.maps.OverlayView();
					overlay.draw = function() {};
					overlay.setMap(map);

                var latLng = new google.maps.LatLng(40.712216,-74.22655)
				//var pointCenter = proj.fromLatLngToDivPixel(latLng);
				
				//alert('point' + overlay.getProjection());
				var point = overlay.getProjection().fromLatLngToContainerPixel(latLng);
			}
			//alert(pointCenter);
			//}
			
			//so you want the x and y coordinate pixel of the marker point,
			//as you want to send this to the service.
			
			//you also want the x and y coordinate pixel of the marker point so 
			//that you can draw a div on that point and therefore may it overable
			
			//var divPixelCentre = google.maps.fromLatLngToDivPixel(center);
		
			//alert(divPixelCentre);
		
		//get the x and y of that point
		//put a dot on the map
		
		//link the dot to the image of the place
		}

        function search(){
            console.log('Search for :' + $('.location-input').val());

            var location = $('.location-input').val();
            getItemAPI(location);
        }

        function searchByCenterPoint(){

            var bounds = map.getBounds();
            var northEastCorner = bounds.getNorthEast();
            var southWestCorner = bounds.getSouthWest();

            console.log(southWestCorner);

            //var lat_lo, lng_lo, lat_hi, lng_hi;
            lat_hi = northEastCorner.lat();
            lng_hi = northEastCorner.lng();
            lat_lo = southWestCorner.lat();
            lng_lo = southWestCorner.lng();

            console.log('Movement');

            //getBounds?
            var centerLatLng = map.getCenter();
            console.log(centerLatLng.lat());
            console.log(centerLatLng.lng());

            var location ='hounslow';

            console.log('lat_hi' + lat_hi + 'lng_hi' + lng_hi + 'lat_lo' + lat_lo + 'lng_lo' + lng_lo);

            getItemAPI(location,centerLatLng.lat(),centerLatLng.lng(),lat_lo,lng_lo,lat_hi,lng_hi);
        }

        function areaSearch(){

            searchByCenterPoint();

        }

    </script>
  </head>
  <body>
  <!-- <div style="position:absolute; z-index:1;">
	<canvas id="myCanvas" width="500" height="500"></canvas>
  </div> -->
  <!--<div style="z-index:2; position:absolute; top:40px;left:200px;">-->
	<!--<div class="item-container"><a href="http://www.google.com">link</a></div>-->
    <!--</div>-->



  <div style="z-index:3; position:absolute; top:170px;left:200px;">x</div>

  <!--<div style="z-index:2; position:absolute; top:50px;left:400px;">-->
    <!--<div class="item-container">hi</div>-->
  <!--</div>-->
          <div>hello</div>
        <div class="display-layer"/>

        <div class='search-layer'>
          <input class='location-input' type='text' value='hounslow'>
          <input type="button" value="Let's go!" onclick="search()">
          <input type="button" value="Area Search" onclick="areaSearch()">
        </div>

        <div style="z-index:0; position:relative; top:0; " id="map-canvas"/>

    </body>
</html>